<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Tobey AI Tutor Chat</title>
  <!--
    1. Style: Using Tailwind CSS CDN to match tobeystutor.com design tokens (gradients, colors, fonts)
    2. Ensure you include this file under your Lovable site's `public/` folder or similar static assets directory.
  -->
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* Custom theme overrides to match brand */
    :root {
      --tobey-orange: #f97316;
      --tobey-darkOrange: #c2410c;
    }
    body {
      font-family: system-ui, sans-serif;
    }
  </style>
</head>
<body class="bg-gradient-to-br from-white to-orange-50 min-h-screen flex items-center justify-center p-4">
  <div id="chat-wrapper" class="flex flex-col w-full max-w-lg bg-white rounded-lg shadow-lg overflow-hidden">
    <!-- Header -->
    <header class="bg-[var(--tobey-orange)] text-white py-4 px-6 font-medium text-lg">
      Tobey AI Tutor
    </header>

    <!-- Messages container -->
    <main id="chat-container" class="flex-1 overflow-y-auto p-4 space-y-4" style="max-height: 500px;">
      <!-- Welcome message -->
      <div class="bg-gray-100 text-gray-800 rounded-2xl p-3 max-w-[80%]">
        <div class="font-medium text-sm mb-1">Tobey</div>
        <p class="text-sm">Hello! I'm Tobey, your AI tutor. How can I help you today?</p>
      </div>
    </main>

    <!-- Typing indicator -->
    <div id="typing-indicator" class="px-6 py-2 text-gray-500 text-sm hidden">
      Tobey is typing...
    </div>

    <!-- Input bar and file upload -->
    <div class="border-t border-gray-200 p-4 flex items-center space-x-2">
      <!-- Text input -->
      <input id="message-input" 
             type="text"
             placeholder="Ask me anything or upload your report card..."
             class="flex-1 border rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-[var(--tobey-orange)]" 
             aria-label="Type your message"
             />

      <!-- Send button -->
      <button id="send-button" 
              class="bg-[var(--tobey-orange)] text-white px-4 py-2 rounded-lg hover:bg-[var(--tobey-darkOrange)] focus:outline-none focus:ring-2 focus:ring-[var(--tobey-darkOrange)]"
              aria-label="Send message">
        Send
      </button>

      <!-- File upload (PDF or image) -->
      <label for="file-input" class="cursor-pointer text-xl" title="Upload report card">
        📎
      </label>
      <input id="file-input"
             type="file"
             accept="application/pdf, image/*"
             class="hidden"
             aria-label="Upload your report card"
      />
    </div>
  </div>

  <!--
    SCRIPT SECTION
    1. Insert your OpenAI API key & Assistant ID below.
    2. This page calls /api/chat which should proxy to `createStreamHandler({ provider: 'openai' })`.
    3. We read upload files as base64 and send them along for analysis in the same thread.
  -->
  <script>
    // ========== CONFIGURATION ==========
    // Replace with your own keys in production or use environment injection
    const OPENAI_API_KEY = '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';    // ← Insert your OpenAI API Key here
    const ASSISTANT_ID    = 'asst_ybm7FkHg4WMJv6150D6XHzuf';     // ← Insert your OpenAI Assistant ID here
    const CHAT_ENDPOINT    = '/api/chat';             // Lovable proxy route

    // Conversation context
    let threadId = null;

    // UI References
    const container = document.getElementById('chat-container');
    const input     = document.getElementById('message-input');
    const sendBtn   = document.getElementById('send-button');
    const fileInput = document.getElementById('file-input');
    const typingEl  = document.getElementById('typing-indicator');

    // ========== HELPER FUNCTIONS ==========
    function appendMessage(sender, text) {
      const wrapper = document.createElement('div');
      wrapper.className = sender === 'user'
        ? 'flex justify-end'
        : 'flex justify-start';

      const bubble = document.createElement('div');
      bubble.className = `max-w-[80%] rounded-2xl p-3 mb-1 whitespace-pre-wrap ${
        sender === 'user'
          ? 'bg-[var(--tobey-orange)] text-white rounded-tr-none'
          : 'bg-gray-100 text-gray-800 rounded-tl-none'
      }`;

      const name = document.createElement('div');
      name.className = 'font-medium text-sm mb-1';
      name.innerText = sender === 'user' ? 'You' : 'Tobey';

      const message = document.createElement('p');
      message.className = 'text-sm';
      message.innerText = text;

      bubble.appendChild(name);
      bubble.appendChild(message);
      wrapper.appendChild(bubble);
      container.appendChild(wrapper);

      // auto-scroll
      container.scrollTop = container.scrollHeight;
    }

    function showTyping() {
      typingEl.classList.remove('hidden');
    }
    function hideTyping() {
      typingEl.classList.add('hidden');
    }

    // ========== MESSAGE SENDING ==========
    async function sendMessage(payload) {
      try {
        showTyping();
        // send threadId, text, optional fileData
        const res = await fetch(CHAT_ENDPOINT, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${OPENAI_API_KEY}`,
            'X-Assistant-ID': ASSISTANT_ID,
          },
          body: JSON.stringify(payload)
        });
        
        // Read streamed response
        const reader = res.body.getReader();
        const decoder = new TextDecoder();
        let done = false;
        let assistantText = '';

        // Capture threadId from response header if provided
        const newThreadId = res.headers.get('x-openai-thread-id');
        if (newThreadId) threadId = newThreadId;

        // Create initial assistant bubble
        appendMessage('assistant', '');
        const lastBubble = container.lastElementChild.querySelector('p');

        while (!done) {
          const { value, done: doneReading } = await reader.read();
          done = doneReading;
          assistantText += decoder.decode(value || new Uint8Array(), { stream: !done });
          lastBubble.innerText = assistantText;
          container.scrollTop = container.scrollHeight;
        }
      } catch (err) {
        console.error('Chat error:', err);
        appendMessage('assistant', 'Sorry, something went wrong. Please try again later.');
      } finally {
        hideTyping();
      }
    }

    // ========== EVENT HANDLERS ==========
    sendBtn.addEventListener('click', () => {
      const text = input.value.trim();
      if (!text) return;
      appendMessage('user', text);
      input.value = '';
      sendMessage({ message: text, threadId });
    });

    input.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendBtn.click();
      }
    });

    fileInput.addEventListener('change', async (e) => {
      const file = e.target.files[0];
      if (!file) return;
      appendMessage('user', `[File Uploaded: ${file.name}]`);

      // Read file as Base64
      const reader = new FileReader();
      reader.onload = () => {
        const base64 = reader.result.split(',')[1];
        // Send the base64 payload for analysis
        sendMessage({
          message: `Here is my report card: ${file.name}`,
          threadId,
          fileName: file.name,
          fileData: base64
        });
      };
      reader.readAsDataURL(file);
    });
  </script>
</body>
</html> 